<Window x:Class="ActormixerSanitizer.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="{Binding WindowTitle}" Height="450" Width="800"
        Icon="Resources/favicon.ico"
        Closing="MainWindow_Closing">
    <Window.Resources>
        <Style x:Key="GraphicToCheckboxStyle" TargetType="{x:Type ToggleButton}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                        <Grid Background="Transparent" Width="28" Height="22"
                      VerticalAlignment="Center" HorizontalAlignment="Center">

                            <!-- The visual for the CHECKED state: a default CheckBox -->
                            <CheckBox x:Name="CheckedVisual"
                              IsChecked="True"
                              IsHitTestVisible="False"
                              Visibility="Collapsed"
                              VerticalAlignment="Center"
                              HorizontalAlignment="Center"
                              Margin="0,0,0,0"/>

                            <!-- The visual for the HOVER state: an unchecked CheckBox -->
                            <CheckBox x:Name="HoverVisual"
                                      IsChecked="False"
                                      IsHitTestVisible="False"
                                      Visibility="Collapsed"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"
                                      Margin="0,0,0,0"/>

                            <!-- The visual for the UNCHECKED state: the image -->
                            <Image x:Name="UncheckedVisual"
                                   Source="{Binding DataContext.ActorIcon, RelativeSource={RelativeSource AncestorType={x:Type ListBox}}}"
								   HorizontalAlignment="Center"
                                   Visibility="Visible"
								   Margin="0,0,8,0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckedVisual" Property="Visibility" Value="Visible" />
                                <Setter TargetName="UncheckedVisual" Property="Visibility" Value="Collapsed" />
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True" />
                                    <Condition Property="IsChecked" Value="False" />
                                </MultiTrigger.Conditions>
                                <Setter TargetName="HoverVisual" Property="Visibility" Value="Visible" />
                                <Setter TargetName="UncheckedVisual" Property="Visibility" Value="Collapsed" />
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </Window.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="0" x:Name="LogViewerRow"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>



        <Grid Grid.Row="1" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Command="{Binding ConnectCommand}"
					Width="60"  Height="45" Margin="0,0,0,0"
					ToolTip="Connect"
                    IsEnabled="{Binding CanConnect}">
                <Grid>
                    <TextBlock Style="{StaticResource FluentIcon}" Text="{Binding ConnectIcon}" 
                               Visibility="{Binding ShowConnectionIcon, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <ProgressBar IsIndeterminate="True" Width="20" Height="20" 
                                 Visibility="{Binding ShowConnectingProgress, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </Grid>
            </Button>

            <Grid Grid.Column="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Separator Grid.Column="0" Margin="10,0,10,0"/>
                <Button Grid.Column="1" Command="{Binding ScanCommand}"
						Width="60"  Height="45" Margin="0,0,0,0"
						ToolTip="Scan"
                        IsEnabled="{Binding IsScanEnabled}">
                    <TextBlock Style="{StaticResource FluentIcon}">&#xE8FE;</TextBlock>
                </Button>
                <Separator Grid.Column="2" Margin="10,0,10,0"/>
                <StackPanel Grid.Column="3" Orientation="Horizontal">
                    <Button Command="{Binding MarkAllCommand}"
							Width="60"  Height="45" Margin="0,0,10,0"
							ToolTip="Mark All"
                            IsEnabled="{Binding IsMarkingEnabled}">
                        <TextBlock Style="{StaticResource FluentIcon}">&#xe8b3;</TextBlock>
                    </Button>
                    <Button Command="{Binding UnmarkAllCommand}"
							Width="60"  Height="45" Margin="0,0,10,0"
							ToolTip="Unmark All"
                            IsEnabled="{Binding IsMarkingEnabled}">
                        <TextBlock Style="{StaticResource FluentIcon}">&#xe8e6;</TextBlock>
                    </Button>
                    <Button Command="{Binding ToggleMarkedCommand}"
							CommandParameter="{Binding ElementName=ActorMixerListBox, Path=SelectedItems}"
							Width="60" Height="45" Margin="0,0,0,0"
							ToolTip="Toggle Marked for Selection"
                            IsEnabled="{Binding IsMarkingEnabled}">
                        <TextBlock Style="{StaticResource FluentIcon}">&#xef1f;</TextBlock>
                    </Button>
                </StackPanel>
                <Separator Grid.Column="4"  Margin="10,0,10,0"/>
                <Button Grid.Column="5" Command="{Binding ShowMarkedListCommand}"
							Width="60"  Height="45" Margin="0,0,10,0"
							ToolTip="Show Marked List"
                            IsEnabled="{Binding IsShowMarkedListEnabled}">
                    <TextBlock Style="{StaticResource FluentIcon}" Text="{Binding ShowMarkedListIcon}"/>
                </Button>
            </Grid>

            <StackPanel Grid.Column="3" Orientation="Horizontal">
                <Button Command="{Binding ThemeChangeCommand}"
					Width="45" Height ="35" Margin="0,0,10,0"
                    VerticalAlignment="Top"
					ToolTip="Change app theme">
                    <TextBlock Style="{StaticResource FluentIcon}" Text="{Binding ThemeIcon}"/>
                </Button>
                <Button Command="{Binding ToggleLogViewerCommand}"
					Width="45" Height ="35" Margin="0,0,0,0"
                    VerticalAlignment="Top"
					ToolTip="Toggle Log Viewer">
                    <TextBlock Style="{StaticResource FluentIcon}">&#xe9a4;</TextBlock>
                </Button>
            </StackPanel>
        </Grid>
        <!-- Replaced DataGrid with ListBox using solution 2: bind ListBoxItem.IsSelected to item.IsSelected -->
        <!-- Replaced StackPanel with Grid to allow ListBox to scroll properly -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <TextBlock Grid.Row="0"
                       Text="Project has been modified. Please run a new scan." 
                       Background="{DynamicResource AccentFillColorDefaultBrush}"
                       Foreground="{DynamicResource TextOnAccentFillColorPrimaryBrush}" 
                       FontWeight="Bold" 
                       HorizontalAlignment="Stretch" 
                       TextAlignment="Center"
                       VerticalAlignment="Center"
                       Padding="10,5,10,5"
                       Margin="0,5,0,5">
                <TextBlock.Visibility>
                    <Binding Path="IsRescanRequired">
                        <Binding.Converter>
                            <BooleanToVisibilityConverter />
                        </Binding.Converter>
                    </Binding>
                </TextBlock.Visibility>
            </TextBlock>
            <ListBox Grid.Row="1"
                 Name="ActorMixerListBox"
                 ItemsSource="{Binding ActorMixers}"
                 SelectionMode="Extended"
                 HorizontalContentAlignment="Stretch"
                 BorderThickness="0"
                 Background="Transparent">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">

                        <!-- Double-click will toggle the checkmark -->
                        <EventSetter Event="MouseDoubleClick" Handler="ListBoxItem_MouseDoubleClick"/>

                        <Setter Property="Tag" Value="{Binding DataContext, ElementName=ActorMixerListBox}"/>
                        <Setter Property="ContextMenu">
                            <Setter.Value>
                                <ContextMenu>
                                    <MenuItem Header="{Binding Name}" IsEnabled="False"/>
                                    <Separator/>
                                    <MenuItem Header="Copy name" Command="{Binding PlacementTarget.Tag.CopyNameCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}">
                                        <MenuItem.Icon>
                                            <TextBlock Style="{StaticResource FluentIcon}">&#xE16F;</TextBlock>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Copy id" Command="{Binding PlacementTarget.Tag.CopyIdCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}">
                                        <MenuItem.Icon>
                                            <TextBlock Style="{StaticResource FluentIcon}">&#xE16F;</TextBlock>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Copy path" Command="{Binding PlacementTarget.Tag.CopyPathCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}">
                                        <MenuItem.Icon>
                                            <TextBlock Style="{StaticResource FluentIcon}">&#xE16F;</TextBlock>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="Select in Wwise" Command="{Binding PlacementTarget.Tag.SelectInWwiseCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" IsEnabled="{Binding PlacementTarget.Tag.IsSelectionEnabled, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                                        <MenuItem.Icon>
                                            <TextBlock Style="{StaticResource FluentIcon}">&#xE2B4;</TextBlock>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Padding="2" Margin="2" BorderBrush="LightGray" BorderThickness="0,0,0,0">
                            <DockPanel>
                                <CheckBox DockPanel.Dock="Left"
                                          IsChecked="{Binding IsMarked, Mode=TwoWay}"
                                          Margin="0,0,0,0"
                                          Style="{StaticResource GraphicToCheckboxStyle}"/>
                                <StackPanel>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding Path}" FontSize="12" Foreground="Gray"/>
                                </StackPanel>
                            </DockPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>

            </ListBox>
        </Grid>

        <GridSplitter Grid.Row="3" Background="Transparent" HorizontalAlignment="Stretch" ShowsPreview="True"/>

        <TextBox Grid.Row="4" Text="{Binding LogText, Mode=OneWay}"
                 IsReadOnly="True" TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"/>

        <Button Grid.Row="5" Command="{Binding ConvertCommand}"
			Height="45" HorizontalAlignment="Stretch" Margin="0,0,0,0"
			ToolTip="Convert Marked to Folders"
			IsEnabled="{Binding IsMarkingEnabled}">
            <StackPanel Orientation="Horizontal">
                <Image Source="{Binding ActorIcon}" Margin="0,0,30,0" Width="24" Height="24" Visibility="{Binding IsMarkingEnabled, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                <TextBlock Style="{StaticResource FluentIcon}" Text="{Binding ConvertIcon}"/>
                <Image Source="{Binding FolderIcon}" Margin="30,0,0,0" Width="24" Height="24" Visibility="{Binding IsMarkingEnabled, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
        </Button>


    </Grid>
</Window>