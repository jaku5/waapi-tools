<ui:FluentWindow x:Class="ActormixerSanitizer.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        Title="Actormixer Sanitizer" Height="450" Width="800"
        Closing="MainWindow_Closing"
        ExtendsContentIntoTitleBar="True">
    <ui:FluentWindow.Resources>
        <Style x:Key="GraphicToCheckboxStyle" TargetType="{x:Type ToggleButton}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                        <Grid Background="Transparent" Width="28" Height="22"
                      VerticalAlignment="Center" HorizontalAlignment="Center">

                            <!-- The visual for the CHECKED state: a default CheckBox -->
                            <CheckBox x:Name="CheckedVisual"
                              IsChecked="True"
                              IsHitTestVisible="False"
                              Visibility="Collapsed"
                              VerticalAlignment="Center"
                              HorizontalAlignment="Center"
                              Margin="-5,0,0,0"/>

                            <!-- The visual for the UNCHECKED state: the image -->
                            <Image x:Name="UncheckedVisual"
                           Source="{Binding DataContext.ActorIcon, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
						   HorizontalAlignment="Left"
                           Visibility="Visible"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckedVisual" Property="Visibility" Value="Visible" />
                                <Setter TargetName="UncheckedVisual" Property="Visibility" Value="Collapsed" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </ui:FluentWindow.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ui:TitleBar Grid.Row="0" Title="Actormixer Sanitizer" Margin="-10,-10,-10,0" />

        <Grid Grid.Row="1" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Command="{Binding ConnectCommand}"
					Width="60" Margin="0,0,0,0" IsEnabled="{Binding IsNotConnected}"
					ToolTip="Connect">
                <ui:SymbolIcon Symbol="{Binding ConnectIcon}" Filled="{Binding IsConnectIconFilled}" FontSize="32" />
            </Button>

            <Grid Grid.Column="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Separator Grid.Column="0" Margin="10,0,10,0"/>
                <Button Grid.Column="1" Command="{Binding ScanCommand}"
						Width="60" Margin="0,0,0,0"
						ToolTip="Scan"
                        IsEnabled="{Binding IsScanEnabled}">
                    <ui:SymbolIcon Symbol="ScanTable24" FontSize="32" />
                </Button>
                <Separator Grid.Column="2" Margin="10,0,10,0"/>
                <StackPanel Grid.Column="3" Orientation="Horizontal">
                    <Button Command="{Binding SelectAllCommand}"
							Width="60" Margin="0,0,10,0"
							ToolTip="Select All">
                        <ui:SymbolIcon Symbol="SelectAllOn24" FontSize="32" />
                    </Button>
                    <Button Command="{Binding SelectNoneCommand}"
							Width="60" Margin="0,0,10,0"
							ToolTip="Select None">
                        <ui:SymbolIcon Symbol="SelectAllOff24" FontSize="32" />
                    </Button>
                    <Button Command="{Binding ToggleSelectedCommand}"
							CommandParameter="{Binding ElementName=ActorMixerListBox, Path=SelectedItems}"
							Width="60" Margin="0,0,0,0"
							ToolTip="Toggle Selected">
                        <ui:SymbolIcon Symbol="MultiselectLtr24" FontSize="32" />
                    </Button>
                </StackPanel>
                <Separator Grid.Column="4"  Margin="10,0,10,0"/>
                <Button Grid.Column="5" Command="{Binding ShowSelectedListCommand}"
							Width="60" Margin="0,0,10,0"
							ToolTip="Show Selected List"
                            IsEnabled="{Binding IsShowSelectedListEnabled}">
                    <ui:SymbolIcon Symbol="{Binding ShowSelectedListIcon}" FontSize="32" />
                </Button>
            </Grid>

            <Button Grid.Column="3" Command="{Binding ThemeChangeCommand}"
					Width="45" Height ="35" Margin="0,0,0,0"
                    VerticalAlignment="Top"
					ToolTip="Change app theme">
                <ui:SymbolIcon Symbol="{Binding ThemeIcon}" FontSize="16" />
            </Button>
        </Grid>
        <!-- Replaced DataGrid with ListBox using solution 2: bind ListBoxItem.IsSelected to item.IsSelected -->
        <ListBox Grid.Row="2"
                 Name="ActorMixerListBox"
                 ItemsSource="{Binding ActorMixers}"
                 SelectionMode="Extended"
                 HorizontalContentAlignment="Stretch"
                 BorderThickness="0"
                 Background="Transparent">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <!-- Keep ListBox selection and the item's IsSelected property synchronized 
                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/> -->
                    <!-- TODO: Errors in calls -->
                    <!-- TODO: Mem leak -->
                    <!-- TODO: Refactor logging -->
                    <!-- TODO: New state check for 2024+ -->
                    <!-- TODO: Add Tests -->
                    <!-- TODO: Icons and shipit -->
                    <!-- TODO: Get info on Connect. Subscribe for additional topics and undo -->

                    <!-- Double-click will toggle the checkmark -->
                    <EventSetter Event="MouseDoubleClick" Handler="ListBoxItem_MouseDoubleClick"/>

                    <Setter Property="Tag" Value="{Binding DataContext, ElementName=ActorMixerListBox}"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem Header="{Binding Name}" IsEnabled="False"/>
                                <Separator/>
                                <MenuItem Header="Copy name" Command="{Binding PlacementTarget.Tag.CopyNameCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                <MenuItem Header="Copy id" Command="{Binding PlacementTarget.Tag.CopyIdCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                <MenuItem Header="Copy path" Command="{Binding PlacementTarget.Tag.CopyPathCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                                <MenuItem Header="Select in Wwise" Command="{Binding PlacementTarget.Tag.SelectInWwiseCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>

            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Border Padding="2" Margin="2" BorderBrush="LightGray" BorderThickness="0,0,0,0">
                        <DockPanel>
                            <CheckBox DockPanel.Dock="Left"
                                          IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                          Margin="0,0,0,0"
                                          Style="{StaticResource GraphicToCheckboxStyle}"/>
                            <StackPanel>
                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding Path}" FontSize="12" Foreground="Gray"/>
                            </StackPanel>
                        </DockPanel>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>

        </ListBox>

        <GridSplitter Grid.Row="3" Background="Transparent" HorizontalAlignment="Stretch" ShowsPreview="True"/>

        <TextBox Grid.Row="4" Text="{Binding LogText, Mode=OneWay}"
                 IsReadOnly="True" TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"/>

        <Button Grid.Row="5" Command="{Binding ConvertCommand}"
			Height="45" HorizontalAlignment="Stretch" Margin="0,0,0,0"
			ToolTip="Convert Selected to Folders"
			IsEnabled="{Binding IsConvertEnabled}">
            <ui:SymbolIcon Symbol="{Binding ConvertIcon}" FontSize="32" />
        </Button>
    </Grid>
</ui:FluentWindow>